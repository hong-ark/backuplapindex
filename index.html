<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift & Rangkuman SLA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body {
      background: #f6f7fb;
      padding: 20px;
    }
    .container {
      max-width: 1100px;
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #resultTable.table thead tr th, #slaTable.table thead tr th {
      background-color: #1976d2 !important;
      color: white !important;
      text-align: center;
      font-weight: 700;
      cursor: pointer;
      padding: 10px;
      user-select: none;
      vertical-align: middle;
      border-color: #1565c0 !important;
    }
    #resultTable.table thead tr th:hover,
    #slaTable.table thead tr th:hover {
      background-color: #1565c0 !important;
    }
    #resultTable td, #slaTable td {
      text-align: center;
      vertical-align: middle;
      font-size: 0.95rem;
    }
    .table-danger {
      background-color: #ffeaea !important;
    }
  </style>
</head>

<body>
<div class="container">
  <h4><b>Laporan Index Shift & Rangkuman SLA</b></h4>
  <p>Input shift → Ambil nama dari GSheet → Upload CSV → Generate Tabel</p>

  <div class="mb-3 row">
    <div class="col-md-2">
      <label class="form-label">Shift</label>
      <select id="shiftInput" class="form-select">
        <option value="">Pilih Shift</option>
        <option value="M">M (Malam)</option>
        <option value="MH1">M H-1 (Malam H-1)</option>
        <option value="S">S (Siang)</option>
        <option value="P">P (Pagi)</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">&nbsp;</label><br />
      <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet</button>
    </div>

    <div class="col-md-6 text-end">
      <label class="form-label">Tanggal dicek:</label>
      <p id="tanggalCek"></p>
    </div>
  </div>

  <hr>

  <div class="mb-3">
    <label class="form-label">Upload CSV</label>
    <input type="file" id="csvFile" class="form-control" accept=".csv" />
  </div>

  <button id="generateBtn" class="btn btn-success mb-3" disabled>Generate Semua Laporan</button>
  <span id="statusText" class="ms-2 text-muted"></span>

  <hr>

  <!-- Laporan 1 -->
  <div id="resultArea" class="mt-4">
    <h5><b>Laporan Index Shift</b></h5>
    <table id="resultTable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>No</th>
          <th id="sortNama">Nama Karyawan</th>
          <th>Shift</th>
          <th id="sortLastCO">LastCO</th>
          <th id="sortIndexCO">IndexCO</th>
          <th id="sortTotalCO">TotalCO</th>
          <th id="sortSLA">SLA</th>
          <th id="sortInProgress">InProgress</th>
          <th id="sortRelasiResolved">RelasiResolved</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="text-end mt-3">
      <button id="downloadBtn1" class="btn btn-outline-primary">Download JPG</button>
    </div>
  </div>

  <hr>

  <!-- Laporan 2 -->
  <div id="slaArea" class="mt-4">
    <h5><b>Rangkuman Lewat SLA (Tipe Lokasi Asal = Store)</b></h5>
    <table id="slaTable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>No</th>
          <th>Kategori Masalah</th>
          <th>Masalah</th>
          <th>Tanggal</th>
          <th>Grand Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="text-end mt-3">
      <button id="downloadBtn2" class="btn btn-outline-primary">Download JPG</button>
    </div>
  </div>

</div>

<script>
// === Konfigurasi & Variabel ===
const GAS_URL = "https://script.google.com/macros/s/AKfycbzR5FqFZM_G3XcPFeurBRFMrU-NNqxMW2ZtSCRIpESCpC4Nz7VzdKRmt-Zx1rJXjnRd-g/exec";
let sheetData=[], csvData=[], lastResults=[];

// === Fungsi bantu ===
function normKey(s){return(s||"").toLowerCase().replace(/[^a-z0-9]/g,'');}
function normalizeName(s){return(s||"").toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'').trim();}
function durasiKeDetik(v){if(!v)return 0;const m=v.match(/(\d+)\s*d\s*(\d+):(\d+):(\d+)/i);if(m)return(+m[1])*86400+(+m[2])*3600+(+m[3])*60+(+m[4]);const m2=v.match(/(\d+):(\d+):(\d+)/);return m2?(+m2[1])*3600+(+m2[2])*60+(+m2[3]):0;}
function similarity(a,b){a=normalizeName(a);b=normalizeName(b);if(!a||!b)return 0;const al=a.length,bl=b.length;const dp=Array.from({length:al+1},()=>Array(bl+1).fill(0));for(let i=0;i<=al;i++)dp[i][0]=i;for(let j=0;j<=bl;j++)dp[0][j]=j;for(let i=1;i<=al;i++)for(let j=1;j<=bl;j++)dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+(a[i-1]===b[j-1]?0:1));const d=dp[al][bl];return 1-d/Math.max(al,bl);}
function ambilJamDariTanggal(s){if(!s)return"-";const m=s.match(/(\d{1,2}):(\d{2})/);return m?`${m[1].padStart(2,'0')}:${m[2]}`:"-";}

// === Ambil Nama dari GSheet ===
document.getElementById("ambilNamaBtn").addEventListener("click",async()=>{
  const shift=document.getElementById("shiftInput").value.trim().toUpperCase();
  if(!shift)return alert("Pilih shift dulu!");
  document.getElementById("statusText").textContent="Mengambil data dari GSheet...";
  try{
    let now=new Date();
    if(shift==="MH1")now.setDate(now.getDate()-1);
    document.getElementById("tanggalCek").textContent=now.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});
    let shifts=shift==="P"?["P","P1"]:[shift];
    sheetData=[];
    for(const s of shifts){
      const res=await fetch(`${GAS_URL}?shift=${s}`);
      const data=await res.json();
      if(!data.ok)throw new Error(data.error);
      sheetData=sheetData.concat((data.karyawan||[]).map(k=>({nama:k.nama.trim(),shift:k.shift.trim()})));
    }
    sheetData=sheetData.filter((v,i,a)=>i===a.findIndex(t=>t.nama===v.nama));
    document.getElementById("generateBtn").disabled=false;
    document.getElementById("statusText").textContent=`✅ ${sheetData.length} nama berhasil diambil (Shift ${shift}).`;
  }catch(e){alert("Gagal ambil data: "+e.message);}
});

// === Load CSV ===
document.getElementById("csvFile").addEventListener("change",e=>{
  const f=e.target.files[0];if(!f)return;
  Papa.parse(f,{header:true,delimiter:";",skipEmptyLines:true,complete:(r)=>{
    const h={};(r.meta.fields||[]).forEach(f=>h[normKey(f)]=f);
    const getCol=(row,names)=>{for(const n of names){for(const k in h){if(k.includes(n))return row[h[k]]||"";}}return"";};
    csvData=r.data.map(x=>({
      kategoriMasalah:getCol(x,["kategorimasalah","kategori"]),
      masalah:getCol(x,["masalah","issue"]),
      tanggal:getCol(x,["tanggal","tgl"]),
      tipeLokasi:(getCol(x,["tipelokasiasal","tipe lokasi asal"])||"").trim(),
      statusSLA:(getCol(x,["statussla","status sla"])||"").trim()
    }));
    document.getElementById("statusText").textContent=`File CSV terbaca: ${csvData.length} baris.`;
  }});
});

// === Generate semua laporan ===
document.getElementById("generateBtn").addEventListener("click",()=>{
  if(!csvData.length)return alert("Upload CSV dulu!");
  renderRangkumanSLA();
});

// === Render tabel rangkuman SLA ===
function renderRangkumanSLA(){
  const tbody=document.querySelector("#slaTable tbody");
  tbody.innerHTML="";
  const dataFilter=csvData.filter(x=>x.statusSLA.toLowerCase().includes("lewat") && x.tipeLokasi.toLowerCase()==="store");
  const grup={};
  dataFilter.forEach(d=>{
    const key=`${d.kategoriMasalah}|${d.masalah}|${d.tanggal}`;
    if(!grup[key])grup[key]={kategori:d.kategoriMasalah,masalah:d.masalah,tanggal:d.tanggal,total:0};
    grup[key].total++;
  });
  const hasil=Object.values(grup);
  hasil.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${r.kategori}</td><td>${r.masalah}</td><td>${r.tanggal}</td><td>${r.total}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("statusText").textContent=`✅ ${hasil.length} data Lewat SLA dirangkum.`;
}

// === Download JPG ===
document.getElementById("downloadBtn1").addEventListener("click",()=>downloadAsJPG("#resultArea","Laporan_Index_Shift.jpg"));
document.getElementById("downloadBtn2").addEventListener("click",()=>downloadAsJPG("#slaArea","Rangkuman_SLA.jpg"));

async function downloadAsJPG(sel,filename){
  const area=document.querySelector(sel);
  const canvas=await html2canvas(area,{scale:2});
  const link=document.createElement("a");
  link.download=filename;
  link.href=canvas.toDataURL("image/jpeg");
  link.click();
}
</script>
</body>
</html>
