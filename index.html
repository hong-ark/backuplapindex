<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
  body {
    background: #f6f7fb;
    padding: 20px;
  }

  .container {
    max-width: 1100px;
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  #resultTable thead {
    background-color: #1976d2;
    color: white;
  }

  #resultTable th {
    text-align: center;
    font-weight: 700;
    cursor: pointer;
    border-bottom: 2px solid #bbdefb;
  }

  #resultTable td {
    text-align: center;
    vertical-align: middle;
  }

  .table-danger {
    background-color: #ffeaea !important;
  }
  </style>
</head>

<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Ambil nama dari GSheet ‚Üí Upload CSV ‚Üí Generate tabel ‚Üí Upload ke Drive.</p>

    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Shift</label>
        <select id="shiftInput" class="form-select">
          <option value="">Pilih Shift</option>
          <option value="P">P (Pagi)</option>
          <option value="S">S (Siang)</option>
          <option value="M">M (Malam)</option>
          <option value="MH1">M H-1 (Malam H-1)</option>
        </select>
      </div>
      <div class="col-md-4 align-self-end">
        <button id="ambilNamaBtn" class="btn btn-primary w-100">Ambil Nama dari GSheet</button>
      </div>
      <div class="col-md-5 text-end">
        <label class="form-label">Tanggal yang dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr />

    <div class="mb-3">
      <label for="csvFile" class="form-label">Upload file CSV dari WEB CO</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
    </div>

    <button id="generateBtn" class="btn btn-success mb-3" disabled>Generate Tabel</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th id="sortNama">Nama Karyawan</th>
            <th>Shift</th>
            <th id="sortLastCO">LastCO</th>
            <th id="sortIndexCO">IndexCO</th>
            <th id="sortTotalCO">TotalCO</th>
            <th id="sortSLA">SLA</th>
            <th id="sortInProgress">InProgress</th>
            <th id="sortRelasiResolved">RelasiResolved</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="uploadDriveBtn" class="btn btn-warning">Upload ke Drive</button>
      <button id="downloadXlsxBtn" class="btn btn-outline-primary">Download XLSX</button>
    </div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzR5FqFZM_G3XcPFeurBRFMrU-NNqxMW2ZtSCRIpESCpC4Nz7VzdKRmt-Zx1rJXjnRd-g/exec";

let sheetData = [];
let csvData = [];

// === Ambil nama dari GSheet ===
document.getElementById("ambilNamaBtn").addEventListener("click", async () => {
  const shift = document.getElementById("shiftInput").value.trim().toUpperCase();
  if (!shift) return alert("Pilih shift terlebih dahulu!");

  document.getElementById("statusText").textContent = "Mengambil data dari Google Sheet...";
  try {
    let tanggal;
    const now = new Date();
    if (shift === "MH1") {
      const y = new Date();
      y.setDate(now.getDate() - 1);
      tanggal = `${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,'0')}-${String(y.getDate()).padStart(2,'0')}`;
    } else {
      tanggal = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    }

    const url = `${GAS_URL}?shift=${encodeURIComponent(shift)}&tanggal=${encodeURIComponent(tanggal)}`;
    const res = await fetch(url);
    const data = await res.json();

    if (!data.ok) throw new Error(data.error || "Gagal mengambil data");

    sheetData = data.karyawan || [];
    document.getElementById("tanggalCek").textContent = new Date(tanggal).toLocaleDateString("id-ID", {
      day: "numeric", month: "long", year: "numeric"
    });
    document.getElementById("statusText").textContent = `‚úÖ ${sheetData.length} nama berhasil diambil.`;
    document.getElementById("generateBtn").disabled = false;
  } catch (err) {
    alert("Gagal mengambil data: " + err.message);
  }
});

// === Upload CSV ===
document.getElementById("csvFile").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  Papa.parse(file, {
    header: true,
    delimiter: ";",
    skipEmptyLines: true,
    complete: (res) => {
      csvData = res.data;
      document.getElementById("statusText").textContent = `File CSV terbaca: ${csvData.length} baris.`;
    }
  });
});

// === Generate Tabel ===
document.getElementById("generateBtn").addEventListener("click", () => {
  if (!sheetData.length || !csvData.length) return alert("Pastikan nama GSheet & CSV sudah diambil!");

  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";

  sheetData.forEach((p, i) => {
    const baris = document.createElement("tr");
    baris.innerHTML = `
      <td>${i+1}</td>
      <td>${p.nama}</td>
      <td>${p.shift}</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>`;
    tbody.appendChild(baris);
  });

  document.getElementById("statusText").textContent = "‚úÖ Tabel berhasil digenerate.";
});

// === Upload ke Drive ===
document.getElementById("uploadDriveBtn").addEventListener("click", async () => {
  const dataFilter = csvData.filter(x =>
    (x["Status SLA"] || "").toLowerCase().includes("lewat") &&
    (x["Tipe Lokasi Asal"] || "").toLowerCase() === "store"
  );
  if (!dataFilter.length) {
    alert("Tidak ada data Lewat SLA (Store) untuk diupload.");
    return;
  }

  const payload = {
    tanggal: new Date().toISOString().split('T')[0],
    data: dataFilter
  };

  document.getElementById("statusText").textContent = "üì§ Mengunggah data rangkuman ke Drive...";
  const res = await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  const hasil = await res.json();
  if (hasil.ok) {
    document.getElementById("statusText").textContent = `‚úÖ ${hasil.added} baris rangkuman diunggah ke Drive.`;
  } else {
    document.getElementById("statusText").textContent = `‚ö†Ô∏è Gagal: ${hasil.error}`;
  }
});

// === Download XLSX (dari Spreadsheet) ===
document.getElementById("downloadXlsxBtn").addEventListener("click", () => {
  const FILE_ID = "ID_SPREADSHEET_RANGKUMAN_SLA"; // ‚Üê ganti dengan ID Spreadsheet rangkumanmu
  const exportUrl = `https://docs.google.com/spreadsheets/d/${FILE_ID}/export?format=xlsx`;
  window.open(exportUrl, "_blank");
});
</script>
</body>
</html>
